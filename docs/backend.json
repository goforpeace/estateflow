{
  "entities": {
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a real estate development project.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the project."
        },
        "location": {
          "type": "string",
          "description": "Location of the project."
        },
        "totalFlats": {
          "type": "number",
          "description": "Total number of flats in the project."
        },
        "developerShare": {
          "type": "number",
          "description": "Percentage share of the project owned by the developer (e.g., 0.5 for 50%)."
        },
        "landownerShare": {
          "type": "number",
          "description": "Percentage share of the project owned by the landowner (e.g., 0.5 for 50%)."
        },
        "startDate": {
          "type": "string",
          "description": "Start date of the project.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Current status of the project (Planning, Ongoing, Completed)."
        }
      },
      "required": [
        "id",
        "name",
        "location",
        "totalFlats",
        "developerShare",
        "landownerShare",
        "startDate",
        "status"
      ]
    },
    "Flat": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Flat",
      "type": "object",
      "description": "Represents a flat within a project.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Flat entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project. (Relationship: Project 1:N Flat)"
        },
        "flatNumber": {
          "type": "string",
          "description": "Flat number or identifier within the project."
        },
        "ownership": {
          "type": "string",
          "description": "Ownership of the flat (Developer or Landowner)."
        },
        "salePrice": {
          "type": "number",
          "description": "Sale price of the flat (only for developer-owned flats)."
        },
        "status": {
          "type": "string",
          "description": "Current status of the flat (Available, Sold, Reserved)."
        }
      },
      "required": [
        "id",
        "projectId",
        "flatNumber",
        "ownership",
        "status"
      ]
    },
    "Customer": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Customer",
      "type": "object",
      "description": "Represents a customer who has purchased or reserved a flat.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Customer entity."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the customer."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the customer."
        },
        "email": {
          "type": "string",
          "description": "Email address of the customer.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "Phone number of the customer."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email",
        "phoneNumber"
      ]
    },
    "InflowTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "InflowTransaction",
      "type": "object",
      "description": "Represents a cash inflow transaction.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the InflowTransaction entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project. (Relationship: Project 1:N InflowTransaction)"
        },
        "flatId": {
          "type": "string",
          "description": "Reference to Flat. (Relationship: Flat 1:N InflowTransaction)"
        },
        "customerId": {
          "type": "string",
          "description": "Reference to Customer. (Relationship: Customer 1:N InflowTransaction)"
        },
        "paymentType": {
          "type": "string",
          "description": "Type of payment (Booking or Installment)."
        },
        "date": {
          "type": "string",
          "description": "Date of the inflow transaction.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "Amount of the inflow transaction."
        },
        "paymentMode": {
          "type": "string",
          "description": "Payment method (Cash or Bank)."
        }
      },
      "required": [
        "id",
        "projectId",
        "flatId",
        "customerId",
        "paymentType",
        "date",
        "amount",
        "paymentMode"
      ]
    },
    "OutflowTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OutflowTransaction",
      "type": "object",
      "description": "Represents a cash outflow transaction (expense).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the OutflowTransaction entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project.  If null, it's an office cost. (Relationship: Project 1:N OutflowTransaction)"
        },
        "expenseCategory": {
          "type": "string",
          "description": "Category of the expense (Material, Labor, Utility, Office)."
        },
        "supplierVendor": {
          "type": "string",
          "description": "Name of the supplier or vendor."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the outflow transaction."
        },
        "date": {
          "type": "string",
          "description": "Date of the outflow transaction.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "expenseCategory",
        "supplierVendor",
        "amount",
        "date"
      ]
    },
    "OfficeExpense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OfficeExpense",
      "type": "object",
      "description": "Represents a monthly office expense.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the OfficeExpense entity."
        },
        "date": {
          "type": "string",
          "description": "Date representing the month of the expense.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "Total amount of the office expense for the month."
        },
        "expenseCategory": {
          "type": "string",
          "description": "Category of the office expense (Rent, Salary, etc.)."
        },
        "supplierVendor": {
          "type": "string",
          "description": "Supplier of the office expense."
        }
      },
      "required": [
        "id",
        "date",
        "amount",
        "expenseCategory"
      ]
    },
    "OfficeCostAllocation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OfficeCostAllocation",
      "type": "object",
      "description": "Represents the allocation of office costs to projects for a specific month.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the OfficeCostAllocation entity."
        },
        "officeExpenseId": {
          "type": "string",
          "description": "Reference to OfficeExpense. (Relationship: OfficeExpense 1:N OfficeCostAllocation)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project. (Relationship: Project 1:N OfficeCostAllocation)"
        },
        "allocationAmount": {
          "type": "number",
          "description": "Amount of office cost allocated to the project."
        },
        "allocationMethod": {
          "type": "string",
          "description": "Method used for allocation (Equal Allocation or Project Size Ratio)."
        }
      },
      "required": [
        "id",
        "officeExpenseId",
        "projectId",
        "allocationAmount",
        "allocationMethod"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "description": "Represents an application user profile.",
      "type": "object",
      "properties": {
        "id": { "type": "string", "description": "User's unique ID, same as Firebase Auth UID." },
        "email": { "type": "string", "format": "email", "description": "User's email address." },
        "firstName": { "type": "string", "description": "User's first name." },
        "lastName": { "type": "string", "description": "User's last name." },
        "role": { "type": "string", "description": "User's role.", "enum": ["Viewer", "Admin"] }
      },
      "required": ["id", "email"]
    },
    "OperatingCostItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OperatingCostItem",
      "description": "Represents an item category for operating costs.",
      "type": "object",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the OperatingCostItem." },
        "name": { "type": "string", "description": "Name of the operating cost item (e.g., Office Rent, Utilities)." }
      },
      "required": ["id", "name"]
    },
    "OperatingCost": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OperatingCost",
      "description": "Represents a general operating cost not tied to a specific project.",
      "type": "object",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the OperatingCost." },
        "date": { "type": "string", "format": "date-time", "description": "Date of the expense." },
        "itemId": { "type": "string", "description": "Reference to the OperatingCostItem." },
        "description": { "type": "string", "description": "A description of the expense." },
        "reference": { "type": "string", "description": "A reference number (e.g., invoice number)." },
        "amount": { "type": "number", "description": "The amount of the expense." }
      },
      "required": ["id", "date", "itemId", "amount"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Collection for storing project entities. Each document represents a real estate project.",
          "params": [
            {
              "name": "projectId",
              "description": "Unique identifier for the project."
            }
          ]
        }
      },
      {
        "path": "/projects/{projectId}/flats/{flatId}",
        "definition": {
          "entityName": "Flat",
          "schema": {
            "$ref": "#/backend/entities/Flat"
          },
          "description": "Subcollection for storing flats within a project. Includes denormalized 'projectId' for authorization independence.",
          "params": [
            {
              "name": "projectId",
              "description": "Unique identifier for the project."
            },
            {
              "name": "flatId",
              "description": "Unique identifier for the flat."
            }
          ]
        }
      },
      {
        "path": "/customers/{customerId}",
        "definition": {
          "entityName": "Customer",
          "schema": {
            "$ref": "#/backend/entities/Customer"
          },
          "description": "Collection for storing customer entities.",
          "params": [
            {
              "name": "customerId",
              "description": "Unique identifier for the customer."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": { "$ref": "#/backend/entities/User" },
          "description": "Collection for storing user profile data.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user, matching Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/projects/{projectId}/inflow_transactions/{inflowTransactionId}",
        "definition": {
          "entityName": "InflowTransaction",
          "schema": {
            "$ref": "#/backend/entities/InflowTransaction"
          },
          "description": "Subcollection for storing inflow transactions related to a specific project. Includes denormalized 'projectId' for authorization independence.",
          "params": [
            {
              "name": "projectId",
              "description": "Unique identifier for the project."
            },
            {
              "name": "inflowTransactionId",
              "description": "Unique identifier for the inflow transaction."
            }
          ]
        }
      },
      {
        "path": "/projects/{projectId}/outflow_transactions/{outflowTransactionId}",
        "definition": {
          "entityName": "OutflowTransaction",
          "schema": {
            "$ref": "#/backend/entities/OutflowTransaction"
          },
          "description": "Subcollection for storing outflow transactions related to a specific project. Includes denormalized 'projectId' for authorization independence.",
          "params": [
            {
              "name": "projectId",
              "description": "Unique identifier for the project."
            },
            {
              "name": "outflowTransactionId",
              "description": "Unique identifier for the outflow transaction."
            }
          ]
        }
      },
      {
        "path": "/operatingCostItems/{itemId}",
        "definition": {
          "entityName": "OperatingCostItem",
          "schema": { "$ref": "#/backend/entities/OperatingCostItem" },
          "description": "Collection for storing operating cost item categories.",
          "params": [
            { "name": "itemId", "description": "Unique identifier for the operating cost item." }
          ]
        }
      },
      {
        "path": "/operatingCosts/{costId}",
        "definition": {
          "entityName": "OperatingCost",
          "schema": { "$ref": "#/backend/entities/OperatingCost" },
          "description": "Collection for storing general operating costs.",
          "params": [
            { "name": "costId", "description": "Unique identifier for the operating cost." }
          ]
        }
      },
      {
        "path": "/office_expenses/{officeExpenseId}",
        "definition": {
          "entityName": "OfficeExpense",
          "schema": {
            "$ref": "#/backend/entities/OfficeExpense"
          },
          "description": "Collection for storing office expense entities.",
          "params": [
            {
              "name": "officeExpenseId",
              "description": "Unique identifier for the office expense."
            }
          ]
        }
      },
      {
        "path": "/office_expenses/{officeExpenseId}/cost_allocations/{costAllocationId}",
        "definition": {
          "entityName": "OfficeCostAllocation",
          "schema": {
            "$ref": "#/backend/entities/OfficeCostAllocation"
          },
          "description": "Subcollection for storing office cost allocations. Includes denormalized 'officeExpenseId' for authorization independence.",
          "params": [
            {
              "name": "officeExpenseId",
              "description": "Unique identifier for the office expense."
            },
            {
              "name": "costAllocationId",
              "description": "Unique identifier for the cost allocation."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/Customer"
          },
          "description": "Collection used to assign users to the 'admin' role. Document existence confers role membership.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the real estate project management and cash flow system, EstateFlow. The structure prioritizes authorization independence through denormalization, enabling secure and scalable access control using Firebase security rules. It also addresses the need for secure and efficient listing of data (QAPs). Hereâ€™s a breakdown:\n\n*   **Authorization Independence**: The key is the `projects/{projectId}` path. Subcollections, like `/flats`, denormalize project-level authorization data (e.g., ownership) into each document within the subcollection. This avoids the need for `get()` calls in security rules, simplifying rule logic and allowing for atomic operations (transactions/batches) involving both parent and child documents. The use of membership maps in collaborative data scenarios further supports this independence.\n*   **Structural Segregation:** The structure ensures that each collection has a homogeneous security posture. Data with different access requirements (e.g., public vs. private) are stored in separate collections or subcollections. For example, project-related data is segregated under the `/projects/{projectId}` path, while user-specific data (if any) would be under `/users/{userId}`.\n*   **Access Modeling:** Consistent access modeling is employed throughout the structure:\n    *   **Path-Based Ownership:** User-owned data (if applicable, such as user profiles or settings) would be stored under `/users/{userId}`.\n    *   **Hierarchical Paths for User-Owned Data:** The structure `/projects/{projectId}/flats/{flatId}` exemplifies the use of hierarchical paths to represent `Project 1:N Flat` relationships. This approach ensures clear ownership and facilitates efficient and secure security rules.\n    *   **Global Roles (DBAC):** Global admin roles are managed via the `/roles_admin/{uid}` collection. This existence-based approach simplifies checking for admin privileges in security rules.\n*   **QAPs (Rules are not Filters):** The structure enables secure `list` operations. For instance, listing flats within a project can be secured by verifying that the requesting user has access to the project. Segregation into subcollections ensures that listing operations don't require filtering based on document content, maintaining security and performance.\n*   **Data Clarity and Predictability:** The structure promotes data clarity through explicit state modeling using `status` fields in entities like `Project` and `Flat`. It enforces strict naming conventions, such as `projectId` and `flatId`, for consistency. The schema is designed to avoid dynamic keys and encourages the use of arrays of objects with static keys where applicable.\n\nThe structure is designed to be highly scalable, secure, and easily debuggable, aligning with the core design principles and strategy mandates."
  }
}
    